# 🧩 MySQL 存储引擎学习笔记

---

## 一、存储引擎简介

存储引擎（Storage Engine）是 MySQL 用于管理表数据和索引的底层模块。  
每个表都可以独立选择引擎（如 InnoDB、MyISAM、Memory 等）。

---

## 二、查看与设置存储引擎

| 操作         | SQL 语句                                         | 说明                       |
|--------------|--------------------------------------------------|----------------------------|
| 查看支持的引擎 | `SHOW ENGINES;`                                 | 查看当前 MySQL 支持哪些引擎 |
| 查看某表引擎  | `SHOW TABLE STATUS LIKE 'table_name'\G`         | 包括 ENGINE、行格式、行数等 |
| 设置默认引擎  | `SET GLOBAL default_storage_engine = 'InnoDB';` | 修改全局默认值              |
| 创建表指定引擎| `CREATE TABLE test(id INT) ENGINE=InnoDB;`      | 仅影响该表                  |
| 修改表引擎    | `ALTER TABLE test ENGINE=MyISAM;`               | 有拷贝操作，慎用大表        |

---

## 三、常见存储引擎对比表

| 特性         | InnoDB | MyISAM | Memory | Archive | Blackhole | NDB Cluster |
|--------------|--------|--------|--------|---------|-----------|-------------|
| 事务支持     | ✅     | ❌     | ❌     | ❌      | ❌        | ✅（部分）   |
| 锁粒度       | 行级锁 | 表级锁 | 表级锁 | 行锁（仅插入） | 无锁 | 行级锁      |
| 外键支持     | ✅     | ❌     | ❌     | ❌      | ❌        | 部分支持     |
| 崩溃恢复     | ✅     | ❌     | ❌     | ✅      | ❌        | ✅           |
| 全文索引     | ✅     | ✅     | ❌     | ❌      | ❌        | ❌           |
| 索引类型     | B+Tree | B+Tree | Hash/BTree | 无或极少 | 无 | Hash/BTree   |
| 数据存储位置 | 磁盘   | 磁盘   | 内存   | 磁盘（压缩） | 无存储 | 分布式节点  |
| 文件结构     | .ibd   | .MYD/.MYI/.frm | 内存中 | .ARZ | 无 | 分布式存储   |
| 读取性能     | ⭐⭐⭐   | ⭐⭐⭐⭐  | ⭐⭐⭐⭐⭐ | ⭐⭐     | ❌        | ⭐⭐           |
| 写入性能     | ⭐⭐⭐⭐  | ⭐⭐    | ⭐⭐⭐⭐  | ⭐⭐     | ⭐⭐        | ⭐⭐⭐          |
| 是否持久化   | ✅     | ✅     | ❌     | ✅      | ❌        | ✅           |
| 适用场景     | OLTP/事务 | 报表/只读 | 临时表/缓存 | 日志归档 | 复制链测试 | 分布式高可用 |
| 备注         | 默认引擎 | 旧版本常用 | 重启即丢失 | 仅插入和查询 | 无数据存储 | 复杂需多节点 |

---

## 四、各引擎详解

### 1️⃣ InnoDB — 默认与推荐引擎

- **事务支持**：完整支持 ACID，具备 redo/undo 日志
- **锁机制**：行级锁 + MVCC，多用户并发性能好
- **外键支持**：支持外键约束
- **文件结构**：.ibd 文件（每表独立）或共享表空间
- **恢复能力**：崩溃后自动恢复（基于日志）
- **适合场景**：需要事务、并发高、安全性要求高的系统
- **关键参数**：innodb_buffer_pool_size、innodb_log_file_size、innodb_flush_log_at_trx_commit

📌 优点：事务安全、数据可靠、行级锁减少阻塞、支持外键与全文索引  
⚠️ 注意：占用更多内存，事务日志会占磁盘空间

---

### 2️⃣ MyISAM — 早期默认引擎

- **事务支持**：不支持
- **锁机制**：表级锁（读写互斥）
- **文件结构**：.MYD（数据） + .MYI（索引） + .frm（表定义）
- **崩溃恢复**：需手动 REPAIR TABLE
- **适合场景**：读多写少、数据量大、低并发应用
- **特殊功能**：支持 FULLTEXT 索引、压缩表

📌 优点：读性能高、文件易复制/迁移  
⚠️ 缺点：无事务、无外键、并发写入性能差

---

### 3️⃣ MEMORY（HEAP）— 内存表

- **存储位置**：全部在内存中（非持久）
- **索引类型**：默认 HASH，可改为 BTREE
- **事务支持**：不支持
- **行格式**：定长，浪费部分内存
- **文件结构**：无，重启后数据丢失
- **限制**：受 max_heap_table_size 和 tmp_table_size 限制
- **适合场景**：临时表、缓存表、会话表、数据中转

⚠️ 注意：服务器重启即丢失数据，不支持 TEXT/BLOB 类型

---

### 4️⃣ ARCHIVE — 压缩归档引擎

- **功能**：仅支持 INSERT 和 SELECT
- **存储方式**：高压缩比，节省磁盘空间
- **索引支持**：极少（通常不支持复杂索引）
- **适合场景**：日志归档、历史记录保存

⚠️ 注意：查询慢（全表扫描），不支持 DELETE/UPDATE

---

### 5️⃣ BLACKHOLE — 数据黑洞

- **功能**：接收写入但不存储任何数据
- **用途**：复制链路中继、日志流量分析
- **存储文件**：无实际数据文件

💡 适合测试写入流量或用于主从复制的中转节点。

---

### 6️⃣ NDB Cluster — 分布式高可用引擎

- **架构**：数据节点 + 管理节点 + SQL 节点
- **特性**：高可用、分布式存储、自动分片
- **事务支持**：部分支持（分布式事务）
- **适合场景**：电信级集群、低延迟高可用系统

⚠️ 难点：部署复杂，对网络延迟敏感

---

## 五、文件结构汇总

| 引擎      | 文件后缀           | 说明                   |
|-----------|--------------------|------------------------|
| InnoDB    | .ibd / .frm（旧）  | 数据 + 索引（独立或共享表空间） |
| MyISAM    | .MYD + .MYI + .frm | 数据 + 索引 + 定义     |
| MEMORY    | 无                 | 数据存内存中           |
| ARCHIVE   | .ARZ               | 压缩数据               |
| BLACKHOLE | 无                 | 无数据存储             |
| NDB       | 分布式存储         | 由集群节点维护         |

---

## 六、存储引擎选择建议

| 场景               | 推荐引擎      | 原因                   |
|--------------------|---------------|------------------------|
| 事务性系统         | InnoDB        | 支持事务与行级锁       |
| 报表系统、只读查询 | MyISAM/InnoDB | 读性能高               |
| 临时缓存、会话表   | MEMORY        | 快速读写               |
| 日志归档           | ARCHIVE       | 高压缩、节省空间       |
| 主从复制中转       | BLACKHOLE     | 写入触发 binlog        |
| 分布式高可用       | NDB Cluster   | 多节点高可用           |

---

## 七、快速示例

```sql
-- 查看所有引擎
SHOW ENGINES;

-- 创建 InnoDB 表
CREATE TABLE emp (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50),
  age INT
) ENGINE=InnoDB;

-- 创建 MyISAM 表
CREATE TABLE emp_log (
  id INT AUTO_INCREMENT PRIMARY KEY,
  log_text TEXT
) ENGINE=MyISAM;

-- MEMORY 表（非持久）
CREATE TABLE cache_temp (
  id INT,
  value VARCHAR(50)
) ENGINE=MEMORY;

-- 查看当前表的引擎
SHOW TABLE STATUS LIKE 'emp'\G
```

---

## 八、易错点总结

| 错误点                   | 原因                    | 后果           |
|--------------------------|-------------------------|----------------|
| 把事务表建为 MyISAM      | MyISAM 不支持事务       | 数据不一致     |
| MEMORY 表存重要数据      | 重启丢失                | 数据丢失       |
| 不调 innodb_buffer_pool_size | 默认过小            | 性能差         |
| 误认为 MyISAM 支持外键   | 不支持                  | 外键失效       |
| 修改大表引擎无备份       | ALTER TABLE 会复制整表  | 数据风险       |

---

## 九、总结口诀（助记）

> InnoDB 稳又全，MyISAM 读快但锁全；  
> Memory 临时存，Archive 归档不删；  
> Blackhole 黑洞空，NDB 集群忙。

---