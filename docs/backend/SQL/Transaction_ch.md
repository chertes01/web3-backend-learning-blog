# 🛡️ SQL 事务（Transaction）控制学习笔记

---

## 目录

- 🤔 什么是事务？一个比喻
- 💎 事务的四大特性（ACID）
- 🚦 事务的隔离级别（知识补充）
- 🕹️ 事务的控制方法
- 🏦 实战演练：模拟银行转账
- ✨ 核心要点总结

---

## 1. 🤔 什么是事务？一个比喻

**定义**：事务是一系列数据库操作的集合，这些操作在逻辑上被视为一个不可分割的整体。它们要么全部成功，要么全部失败。

**ATM取钱场景举例**：

1. 插卡输密码
2. 输入金额
3. ATM吐钞
4. 银行账户扣款

这四个步骤必须作为一个整体。如果ATM吐了钱但账户没扣款（银行亏了），或者账户扣了款但ATM没吐钱（你亏了），都是灾难。事务机制就是确保这类操作“一荣俱荣，一损俱损”。

---

## 2. 💎 事务的四大特性（ACID）

ACID 是事务可靠性的基石，也是数据库面试高频考点。

- **A - Atomicity（原子性）**  
  含义：事务中的所有操作要么全部完成，要么全部取消。  
  比喻：转账操作，减款和加款不可分割。

- **C - Consistency（一致性）**  
  含义：事务执行前后，数据库从一个有效状态转变到另一个有效状态。  
  比喻：无论多少次转账，银行所有账户的总金额不变。

- **I - Isolation（隔离性）**  
  含义：多个事务并发执行时，一个事务的执行不应被其他事务干扰。  
  比喻：你在ATM取钱时，其他人无法看到你账户金额的中间变化。

- **D - Durability（持久性）**  
  含义：事务一旦提交，其结果就是永久性的。  
  比喻：ATM提示“交易成功”后，即使银行系统断电，这笔交易也不会丢失。

---

## 3. 🚦 事务的隔离级别（知识补充）

隔离性不是绝对的，为了平衡性能和数据一致性，SQL定义了4种隔离级别：

| 隔离级别                | 脏读 | 不可重复读 | 幻读 |
|-------------------------|------|------------|------|
| 读未提交 (Read Uncommitted) | 可能 | 可能       | 可能 |
| 读已提交 (Read Committed)   | 避免 | 可能       | 可能 |
| 可重复读 (Repeatable Read)  | 避免 | 避免       | 可能 |
| 可串行化 (Serializable)     | 避免 | 避免       | 避免 |

💡 MySQL InnoDB 默认隔离级别：**可重复读（Repeatable Read）**，能解决大部分并发问题。

---

## 4. 🕹️ 事务的控制方法

在 MySQL 中，主要有两种方式控制事务：

### 方式一：临时关闭自动提交

MySQL 默认每条 SQL 都是一个事务并自动提交。可以临时关闭：

```sql
SET @@autocommit = 0; -- 关闭自动提交

-- ... 执行你的SQL操作 ...

COMMIT;    -- 手动提交
-- 或 ROLLBACK; -- 手动回滚

SET @@autocommit = 1; -- 恢复默认设置
```

### 方式二：显式开启事务（推荐）

更常用、更清晰，影响范围小，最佳实践：

```sql
START TRANSACTION;
-- ...SQL操作...
COMMIT;    -- 提交
-- 或 ROLLBACK; -- 回滚
```

---

## 5. 🏦 实战演练：模拟银行转账

**场景**：张三（money: 2000）给李四（money: 2000）转账 1000 元。

### 准备工作

```sql
CREATE TABLE account (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(10),
    money INT
);
INSERT INTO account(name, money) VALUES ('张三', 2000), ('李四', 2000);
```

### 转账流程

```sql
-- 1. 开启事务
START TRANSACTION;

-- 2. 张三账户减1000
UPDATE account SET money = money - 1000 WHERE name = '张三';
-- 此时，仅在当前会话中，张三的钱变少了，其他人看不到。

-- (假设此时突发意外，比如程序崩溃或网络中断)

-- 3. 李四账户加1000
UPDATE account SET money = money + 1000 WHERE name = '李四';

-- 4. 检查操作结果，决定最终命运
COMMIT;    -- 一切顺利，提交，所有人都能看到新余额
-- 或
ROLLBACK;  -- 有错误，回滚，数据库回到事务开始前状态
```

---

## 6. ✨ 核心要点总结

- 事务是保证数据一致性的核心机制。
- ACID 是事务必须遵守的四个黄金法则。
- 使用 `START TRANSACTION` 明确管理事务单元，最安全可靠。
- 操作成功，使用 `COMMIT` 提交。
- 遇到问题，使用 `ROLLBACK` 回滚，保护数据安全。

---