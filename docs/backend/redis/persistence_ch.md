# Redis æŒä¹…åŒ–æœºåˆ¶è¯¦è§£ï¼ˆRedis 7.0.15ï¼‰

## ðŸ§© ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆè¦äº†è§£æŒä¹…åŒ–

Redis æ˜¯ä¸€ä¸ªåŸºäºŽå†…å­˜çš„é«˜æ€§èƒ½æ•°æ®åº“ã€‚æ‰€æœ‰æ•°æ®é»˜è®¤å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ä¸€æ—¦é‡å¯æˆ–æ–­ç”µï¼Œæ•°æ®å°±å¯èƒ½å…¨éƒ¨ä¸¢å¤±ã€‚

ä¸ºäº†åœ¨é‡å¯åŽè¿˜èƒ½æ¢å¤æ•°æ®ï¼ŒRedis æä¾›äº†ä¸‰ç§æŒä¹…åŒ–æœºåˆ¶ï¼š

- **RDBï¼ˆå¿«ç…§ï¼‰**
- **AOFï¼ˆè¿½åŠ æ—¥å¿—ï¼‰**
- **RDB + AOF æ··åˆæŒä¹…åŒ–**ï¼ˆRedis 4.0+ï¼‰

---

## ðŸ§ª äºŒã€å°å®žéªŒï¼šæ•°æ®ä¸ºä½•ä¼šâ€œéšæœºæ¶ˆå¤±â€

#### å®žéªŒæ­¥éª¤

1.  è®¾ç½®ä¸¤ä¸ªé”®ï¼š

    ```shell
    127.0.0.1:6379> SET aa aa
    OK
    127.0.0.1:6379> SET bb bb
    OK
    127.0.0.1:6379> KEYS *
    1) "aa"
    2) "bb"
    ```

2.  ç„¶åŽé‡å¯ Redisï¼š

    ```bash
    sudo systemctl restart redis
    ```

3.  å†æ¬¡æŸ¥çœ‹ï¼š

    ```shell
    127.0.0.1:6379> KEYS *
    (empty array)
    ```

#### å®žéªŒç»“æžœå¯èƒ½æœ‰ä»¥ä¸‹å‡ ç§ï¼š

| çŽ°è±¡ | è¯´æ˜Ž |
| :--- | :--- |
| âœ… `aa`ã€`bb` éƒ½åœ¨ | æ•°æ®å·²è¢«æŒä¹…åŒ– |
| âš ï¸ `aa` åœ¨ï¼Œ`bb` ä¸åœ¨ | éƒ¨åˆ†æ•°æ®æœªå†™å…¥ç£ç›˜ |
| âŒ å…¨éƒ¨ä¸åœ¨ | Redis æ²¡æœ‰æ‰§è¡Œä»»ä½•æŒä¹…åŒ–æ“ä½œ |

**æ€è€ƒ**ï¼šä¸ºä»€ä¹ˆè¡Œä¸ºâ€œéšæœºâ€ï¼Ÿå…¶å®žå®ƒå¹¶ä¸éšæœºï¼Œè€Œæ˜¯ç”±æŒä¹…åŒ–æœºåˆ¶çš„è§¦å‘æ¡ä»¶å†³å®šçš„ã€‚

---

## âš™ï¸ ä¸‰ã€Redis 7.0.15 çš„é»˜è®¤æŒä¹…åŒ–é…ç½®

ä½ å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹å½“å‰é…ç½®ï¼š

- **RDB é…ç½®**ï¼š

  ```shell
  127.0.0.1:6379> CONFIG GET save
  1) "save"
  2) "3600 1 300 100 60 10000"
  ```

  è¿™è¡¨ç¤º RDB æŒä¹…åŒ–æ˜¯**å¼€å¯**çš„ã€‚

- **AOF é…ç½®**ï¼š

  ```shell
  127.0.0.1:6379> CONFIG GET appendonly
  1) "appendonly"
  2) "no"
  ```

  è¿™è¡¨ç¤º AOF æŒä¹…åŒ–æ˜¯**å…³é—­**çš„ã€‚

---

## ðŸ“ å››ã€é»˜è®¤é…ç½®è§£æž

| é…ç½®è§„åˆ™ | è§¦å‘æ¡ä»¶ | å«ä¹‰ |
| :--- | :--- | :--- |
| `save 3600 1` | 1 å°æ—¶å†…è‡³å°‘ 1 æ¬¡å†™æ“ä½œ | æ¯å°æ—¶è‡³å°‘æœ‰å˜æ›´æ—¶ä¿å­˜å¿«ç…§ |
| `save 300 100` | 5 åˆ†é’Ÿå†…è‡³å°‘ 100 æ¬¡å†™æ“ä½œ | å†™å…¥é¢‘ç¹æ—¶æå‰ä¿å­˜ |
| `save 60 10000` | 1 åˆ†é’Ÿå†…è‡³å°‘ 10000 æ¬¡å†™æ“ä½œ | å†™å…¥æžå¤šæ—¶å¿«é€Ÿä¿å­˜ |
| `appendonly no` | ä¸å¯ç”¨ AOF | ä¸è¿½åŠ å†™å…¥æ—¥å¿— |

#### ðŸ” æ–‡ä»¶ä½ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼š

- `dbfilename dump.rdb`
- `dir /var/lib/redis/`

æ‰€ä»¥ RDB æ–‡ä»¶ä¸€èˆ¬ä½äºŽï¼š`/var/lib/redis/dump.rdb`

---

## ðŸ§  äº”ã€ä¸ºä»€ä¹ˆä¼šâ€œéšæœºä¸¢æ•°æ®â€

| åœºæ™¯ | æŒä¹…åŒ–æ–¹å¼ | ä¸¢å¤±åŽŸå›  |
| :--- | :--- | :--- |
| å†™å®Œç«‹åˆ»é‡å¯ | RDB | å¿«ç…§æœªè§¦å‘ä¿å­˜ |
| çŸ­æ—¶é—´å¤§é‡å†™å…¥ | RDB | ä¸æ»¡è¶³å†™æ¬¡æ•°æ¡ä»¶ |
| å¼‚å¸¸å®•æœº | AOF å…³é—­ | æ²¡æœ‰è¿½åŠ æ—¥å¿— |
| éƒ¨åˆ†é”®å­˜åœ¨ | RDB/AOF æ··åˆ | AOF æ–‡ä»¶æœªå®Œå…¨å†™å…¥æˆ–æœªåŠ è½½ |

Redis åœ¨é‡å¯æ—¶ä¼˜å…ˆåŠ è½½é¡ºåºå¦‚ä¸‹ï¼š

1.  `appendonly.aof`ï¼ˆè‹¥å­˜åœ¨ï¼‰
2.  `dump.rdb`ï¼ˆè‹¥æ—  AOFï¼‰
3.  ç©ºæ•°æ®åº“ï¼ˆéƒ½ä¸å­˜åœ¨ï¼‰

---

## ðŸ§¾ å…­ã€éªŒè¯å¿«ç…§çŠ¶æ€

ä½¿ç”¨ `INFO Persistence` å‘½ä»¤æŸ¥çœ‹ RDB ç›¸å…³çŠ¶æ€ï¼š

```shell
redis-cli INFO Persistence | grep rdb
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
rdb_changes_since_last_save:10
rdb_bgsave_in_progress:0
rdb_last_save_time:1735192443
rdb_last_bgsave_status:ok
```

| å­—æ®µ | å«ä¹‰ |
| :--- | :--- |
| `rdb_last_save_time` | ä¸Šæ¬¡ä¿å­˜æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰ |
| `rdb_changes_since_last_save` | è‡ªä¸Šæ¬¡ä¿å­˜åŽä¿®æ”¹çš„ key æ•°é‡ |
| `rdb_last_bgsave_status` | æœ€è¿‘ä¸€æ¬¡å¿«ç…§ç»“æžœ |
| `rdb_bgsave_in_progress` | å½“å‰æ˜¯å¦åœ¨æ‰§è¡Œå¿«ç…§ |

---

## ðŸ§® ä¸ƒã€ä¸‰ç§æŒä¹…åŒ–æœºåˆ¶å¯¹æ¯”

| æŒä¹…åŒ–æ–¹å¼ | æ–‡ä»¶å | æŒä¹…åŒ–æ—¶æœº | æ€§èƒ½ | æ•°æ®å®‰å…¨æ€§ | Redis 7 é»˜è®¤çŠ¶æ€ |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **RDB** | `dump.rdb` | å®šæœŸç”Ÿæˆå¿«ç…§ | å¿« | âš ï¸ å¯èƒ½ä¸¢å¤±æœ€è¿‘æ•°æ® | âœ… **å¼€å¯** |
| **AOF** | `appendonly.aof` | æ¯æ¬¡å†™å‘½ä»¤è¿½åŠ æ—¥å¿— | ä¸­ | âœ… å¯å®žæ—¶ä¿å­˜ | âŒ **å…³é—­** |
| **RDB + AOF æ··åˆ** | åŒæ—¶å­˜åœ¨ | ç»¼åˆä¸¤è€…ä¼˜ç‚¹ | è¾ƒå¿« | âœ… é«˜å¯é  | âŒ **å…³é—­** |

---

## ðŸ’¡ å…«ã€æŽ¨èé…ç½®ï¼ˆå¼€å‘/ç”Ÿäº§é€šç”¨ï¼‰

```conf
# å¼€å¯ RDB å¿«ç…§
save 900 1
save 300 10
save 60 10000

# å¼€å¯ AOF æŒä¹…åŒ–
appendonly yes
appendfsync everysec     # æ¯ç§’åˆ·ç›˜ï¼Œæ€§èƒ½ä¸Žå®‰å…¨å¹³è¡¡
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
```

**ðŸ“Œ å»ºè®®**ï¼š

- **å¼€å‘çŽ¯å¢ƒ**ï¼šå¯ä»¥åªç”¨ RDBã€‚
- **ç”Ÿäº§çŽ¯å¢ƒ**ï¼š**RDB + AOF æ··åˆ** æœ€å®‰å…¨ã€‚

---

## ðŸ§­ ä¹ã€æ€»ç»“

| ç‰¹æ€§ | Redis é»˜è®¤è¡Œä¸ºï¼ˆ7.0.15ï¼‰ |
| :--- | :--- |
| **RDB** | âœ… **å¼€å¯**ï¼Œå‘¨æœŸæ€§è§¦å‘ï¼ˆ3600s/300s/60sï¼‰ |
| **AOF** | âŒ **é»˜è®¤å…³é—­** |
| **æ··åˆæ¨¡å¼** | âŒ **é»˜è®¤å…³é—­** |
| **æ•°æ®ä¸¢å¤±** | âš ï¸ å¿«ç…§æœªè§¦å‘æ—¶ï¼Œé‡å¯åŽæ•°æ®ä¸¢å¤± |
| **å¿«ç…§æ–‡ä»¶ä½ç½®** | `/var/lib/redis/dump.rdb` |

**ðŸ§  ç»“è®º**ï¼š
Redis 7 é»˜è®¤å¯ç”¨äº† RDB å¿«ç…§æœºåˆ¶ï¼Œä½†ä¿å­˜å‘¨æœŸè¾ƒé•¿ã€‚å¦‚æžœä½ å†™å…¥æ•°æ®åŽç«‹å³é‡å¯ Redisï¼Œå¾ˆå¯èƒ½çœ‹èµ·æ¥â€œéšæœºä¸¢æ•°æ®â€ï¼Œå®žé™…ä¸Šæ˜¯å¿«ç…§æœºåˆ¶è¿˜æ²¡è§¦å‘ã€‚

---

## ðŸ“š åã€é™„å½•ï¼šå¿«é€Ÿå‘½ä»¤å‚è€ƒ

| æ“ä½œ | å‘½ä»¤ |
| :--- | :--- |
| æ‰‹åŠ¨ä¿å­˜å¿«ç…§ | `SAVE`ï¼ˆé˜»å¡žï¼‰ / `BGSAVE`ï¼ˆåŽå°å¼‚æ­¥ï¼‰ |
| æ‰‹åŠ¨è§¦å‘ AOF é‡å†™ | `BGREWRITEAOF` |
| æŸ¥çœ‹å½“å‰æŒä¹…åŒ–é…ç½® | `CONFIG GET save` / `CONFIG GET appendonly` |
| æŸ¥çœ‹å¿«ç…§çŠ¶æ€ | `INFO Persistence` |
| ç¦ç”¨ RDB | `CONFIG SET save ""` |

---

## ðŸŽ¨ åä¸€ã€æŽ¨èå›¾ç¤ºï¼ˆå¯é€‰ï¼‰

å¦‚æžœè¦å‘å¸ƒåˆ° `README.md`ï¼Œå¯é™„åŠ ä¸‹å›¾è¯´æ˜ŽæŒä¹…åŒ–æœºåˆ¶å…³ç³»ï¼š

```
å†…å­˜æ•°æ®å˜åŒ–
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  RDBå¿«ç…§ â”‚â”€â”€â–º dump.rdbï¼ˆå‘¨æœŸä¿å­˜ï¼‰
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  AOFæ—¥å¿— â”‚â”€â”€â–º appendonly.aofï¼ˆå‘½ä»¤è®°å½•ï¼‰
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
  Redisé‡å¯æ—¶æŒ‰ä¼˜å…ˆçº§æ¢å¤
      (AOF > RDB)
```
